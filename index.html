<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>COâ‚‚ Monitor Dashboard</title>

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#0e141b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="COâ‚‚ Monitor">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>

  <!-- Leaflet Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body {
      background-color: #0e141b;
      color: #cce7ff;
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }

    h1 {
      color: #26b3ff;
      margin: 20px 10px;
      font-size: clamp(1.5rem, 5vw, 2.5rem);
    }

    label, select {
      font-size: 1rem;
    }

    select {
      background: #1e2a35;
      color: #cce7ff;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      margin-left: 8px;
    }

    .container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
      margin: 20px auto;
      padding: 10px;
      max-width: 1200px;
    }

    .chart-container, .map-container {
      background: #121c24;
      border-radius: 18px;
      box-shadow: 0 0 15px rgba(0,0,0,0.4);
      padding: 10px;
      flex: 1;
      min-width: 320px;
    }

    .chart-container {
      height: 400px;
    }

    .map-container {
      height: 400px;
      position: relative;
    }

    #map {
      width: 100%;
      height: 100%;
      border-radius: 12px;
    }

    #latest {
      font-size: 22px;
      font-weight: bold;
      color: #cce7ff;
      margin-top: 12px;
    }

    /* ðŸ§  Responsive layout for mobile */
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
        align-items: center;
      }

      .chart-container, .map-container {
        width: 95%;
        height: auto;
      }

      #map {
        height: 300px;
      }

      #latest {
        font-size: 20px;
        margin-top: 8px;
      }
    }

    .leaflet-container {
      touch-action: none;
    }
  </style>
</head>
<body>
  <h1>COâ‚‚ Monitor Dashboard</h1>
  <label>Time Range:</label>
  <select id="timeRange">
    <option>Last Hour</option>
    <option>Last 12 Hours</option>
    <option>Today</option>
    <option>Last 7 Days</option>
    <option>Last Month</option>
    <option>All Time</option>
  </select>

  <div class="container">
    <div class="chart-container">
      <canvas id="co2Chart"></canvas>
    </div>

    <div class="map-container">
      <div id="map"></div>
      <div id="latest">Latest: -- ppm</div>
    </div>
  </div>

  <script>
    // === Firebase Config ===
    const firebaseConfig = {
      apiKey: "AIzaSyCV6nLejaXVDasEN6sZNx6E3m8LQbt4z-E",
      authDomain: "co2-sensor-ethan.firebaseapp.com",
      databaseURL: "https://co2-sensor-ethan-default-rtdb.firebaseio.com",
      projectId: "co2-sensor-ethan",
      storageBucket: "co2-sensor-ethan.firebasestorage.app",
      messagingSenderId: "369605628219",
      appId: "1:369605628219:web:4725ce681b84272d8f671e"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // === Chart Setup ===
    const ctx = document.getElementById('co2Chart').getContext('2d');
    const co2Chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: "COâ‚‚ (ppm)",
          borderColor: "#26b3ff",
          backgroundColor: "#26b3ff",
          data: [],
          tension: 0.35,
          pointRadius: 5,
          pointBackgroundColor: "#26b3ff",
          borderWidth: 3,
          fill: false
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks: {
              color: "#cce7ff",
              callback: function(value) {
                const date = new Date(this.getLabelForValue(value));
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
              }
            },
            grid: { color: "rgba(255,255,255,0.1)" }
          },
          y: {
            ticks: { color: "#cce7ff" },
            grid: { color: "rgba(255,255,255,0.1)" },
            title: { display: true, text: "ppm", color: "#cce7ff" }
          }
        },
        plugins: {
          legend: { labels: { color: "#cce7ff" } }
        }
      }
    });

    // === Map Setup ===
    const map = L.map('map', { zoomControl: false, tap: false }).setView([45.5095, -122.68], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(map);
    let marker, label;

    function getColor(ppm) {
      if (ppm >= 3000) return "black";
      if (ppm >= 2000) return "red";
      if (ppm >= 1200) return "yellow";
      if (ppm >= 700) return "white";
      return "green";
    }

    function fetchData() {
      db.ref("readings").limitToLast(2000).once("value", snapshot => {
        const data = snapshot.val();
        if (!data) return;
        const entries = Object.values(data);
        const now = Date.now();
        const range = document.getElementById("timeRange").value;
        const filtered = entries.filter(e => {
          if (!e.timestamp) return false;
          const diff = now - e.timestamp * 1000;
          switch (range) {
            case "Last Hour": return diff < 3600000;
            case "Last 12 Hours": return diff < 43200000;
            case "Today": return diff < 86400000;
            case "Last 7 Days": return diff < 604800000;
            case "Last Month": return diff < 2592000000;
            default: return true;
          }
        });
        const labels = filtered.map(e => new Date(e.timestamp * 1000));
        const co2Values = filtered.map(e => e.co2);
        co2Chart.data.labels = labels;
        co2Chart.data.datasets[0].data = co2Values;
        co2Chart.update();

        if (filtered.length > 0) {
          const latest = filtered[filtered.length - 1];
          const ppm = latest.co2;
          document.getElementById("latest").textContent = `Latest: ${ppm} ppm`;

          const color = getColor(ppm);
          const textColor = color === "black" ? "white" : "black";
          if (marker) map.removeLayer(marker);
          if (label) map.removeLayer(label);
          const markerHtml = `<div style="background:${color};color:${textColor};width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px;border:2px solid rgba(255,255,255,0.5);">${ppm}</div>`;
          const customIcon = L.divIcon({ html: markerHtml, className: '', iconSize: [40, 40] });
          const lat = 45.5152;
          const lon = -122.6784;
          const locationName = "Portland";
          marker = L.marker([lat, lon], { icon: customIcon }).addTo(map);
          const labelHtml = `<div style="position: relative; top: -20px; left: 50px; color: white; font-size: 15px; font-weight: bold; text-shadow: 1px 1px 3px black; background: rgba(0,0,0,0.4); padding: 3px 6px; border-radius: 8px; white-space: nowrap;">${locationName}</div>`;
          label = L.marker([lat, lon], { icon: L.divIcon({ html: labelHtml, className: '' }) }).addTo(map);
        }
      });
    }

    setInterval(fetchData, 30000);
    document.getElementById("timeRange").addEventListener("change", fetchData);
    fetchData();

    // === PWA Service Worker Registration ===
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js');
      });
    }
  </script>
</body>
</html>
